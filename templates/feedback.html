<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="shortcut icon" href="/static/images/verve.png" type="image/x-icon">
    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/adminHome.css">
    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- GOOGLE FONT LINK -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,200;9..40,300;9..40,400;9..40,500&family=Kalnia:wght@100;200;300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Libre+Caslon+Display&family=Libre+Caslon+Text:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sacramento&display=swap" rel="stylesheet">
    <!-- ITALIANA GOOGLE FONT LINK -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&display=swap" rel="stylesheet">

    <!-- Boxicons CSS and JS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

    <!-- CUSTOM JS -->
    <script src="/static/javascript/admin.js" defer></script>

    <!-- FONTAWESOME LINk -->
    <script src="https://kit.fontawesome.com/226d183df1.js" crossorigin="anonymous"></script>
    <!-- highlighter -->
    <svg xmlns="//www.w3.org/2000/svg" version="1.1" class="svg-filters" style="display:none;">
        <defs>
            <filter id="marker-shape">
                <feTurbulence type="fractalNoise" baseFrequency="0 0.15" numOctaves="1" result="warp" />
                <feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="30" in="SourceGraphic" in2="warp" />
            </filter>
        </defs>
    </svg>
    <!-- JQUERY LINK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

</head>

<body>

    <nav class="sidebar close">
        <header>
            <div class="image-text">
                <span class="image">
                    <img src="/static/images/verve.png" alt="">
                </span>
                <div class="text logo-text">
                    <span class="name">Verve</span>
                    <span class="profession">The Thrift Store</span>
                </div>
            </div>
            <i class='bx bx-chevron-right toggle'></i>
        </header>
        <div class="menu-bar">
            <div class="menu">
                <li class="search-box">
                    <i class='bx bx-search icon'></i>
                    <input type="text" placeholder="Search...">
                </li>
                <ul class="menu-links ">
                    <li class="nav-link active-link">
                        <a href="/admin-home">
                            <i class='bx bx-home-alt icon'></i>
                            <span class="text nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-link">
                        <a href="/order-data">
                            <i class='bx bx-bell icon'></i>
                            <span class="text nav-text">Orders Placed</span>
                        </a>
                    </li>
                    <li class="nav-link">
                        <a href="/order-completed-data">
                            <i class='bx bx-badge-check icon'></i>
                            <span class="text nav-text">Completed</span>
                        </a>
                    </li>
                    <li class="nav-link">
                        <a href="/order-incomplete-data">
                            <i class='bx bx-message-alt-x icon'></i>
                            <span class="text nav-text">Incomplete</span>
                        </a>
                    </li>
                    <li class="nav-link">
                        <a href="/user-feedback">
                            <!-- <i class='bx bx-pie-chart-alt icon'></i> -->
                            <i class='bx bx-message-square-dots icon'></i>
                            <span class="text nav-text">User Feedback</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="bottom-content">
                <li class="">
                    <a href="/admin-logout">
                        <i class='bx bx-log-out icon'></i>
                        <span class="text nav-text">Logout</span>
                    </a>
                </li>
                <li class="mode">
                    <div class="sun-moon">
                        <i class='bx bx-moon icon moon'></i>
                        <i class='bx bx-sun icon sun'></i>
                    </div>
                    <span class="mode-text text">Dark mode</span>
                    <div class="toggle-switch">
                        <span class="switch"></span>
                    </div>
                </li>

            </div>
        </div>
    </nav>
    <section class="home">

        <div class="orderData-Section" id="orders-placed">
            <h2>User Feedback</h2>
            <table class="mb-5">
                <thead>
                    <tr>
                        <th>Posted By</th>
                        <!-- <th>Customer Name</th> -->
                        <th>Customer Email</th>
                        <th>Phone Number</th>
                        <th>Feedback</th>
                        <th>Posted On Date</th>
                        <th>Posted at Time</th>
                        <th>Respond</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feedback in feedbacks %}
                    <tr>
                        <!-- <td>{{ feedback.posted_by }}</td> -->
                        <td id="CustomerName">{{ feedback.contacted_user_fullName }}</td>
                        <td id="customerEmail">{{ feedback.contacted_user_email }}</td>
                        <td>{{ feedback.contacted_user_phone }}</td>
                        <td id="customerFeedback">{{ feedback.contacted_user_Feedback }}</td>
                        <td>{{ feedback.Posted_on_date }}</td>
                        <td>{{ feedback.Posted_on_time }}</td>
                        {% if feedback.response_sent %}
                        <td>Responded</td>
                        {% else %}
                        <td id="responseCell"><button
                                onclick="openResponseModal('{{ feedback.contacted_user_email }}', '{{ feedback.contacted_user_fullName }}', '{{ feedback.contacted_user_Feedback }}')">Respond</button>
                        </td>

                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </section>

    <div id="responseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeResponseModal()">
                <p>&times;</p>
            </span>
            <textarea id="responseTextarea" rows="8" cols="50" placeholder="Enter Your Response"></textarea>
            <!-- <input type="hidden" id="feedbackId" name="feedbackId"> -->
            <button onclick="sendResponse()">Send</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
        function openResponseModal(email, CustomerName, customerFeedback) {
            console.log("Email:", email);
            console.log("CustomerName:", CustomerName);
            console.log("CustomerFeedback:", customerFeedback);

            var modal = document.getElementById("responseModal");
            var textarea = document.getElementById("responseTextarea");
            textarea.value = "";
            modal.style.display = "block";
            // Set hidden input values to store the email and feedback ID
            document.getElementById("customerEmail").value = email;
            document.getElementById("CustomerName").innerText = CustomerName;
            document.getElementById("customerFeedback").innerText = customerFeedback;
        }


        function closeResponseModal() {
            var modal = document.getElementById("responseModal");
            modal.style.display = "none";
        }

        function sendResponse() {
            var textarea = document.getElementById("responseTextarea");
            var response = textarea.value;
            var email = document.getElementById("customerEmail").value; // Get the email from the table cell
            var CustomerName = document.getElementById("CustomerName").innerText; // Get the customer name from the table cell
            var customerFeedback = document.getElementById("customerFeedback").innerText;

            $.ajax({
                type: "POST",
                url: "/send-response",
                data: { response: response, email: email, CustomerName: CustomerName, customerFeedback: customerFeedback },
                success: function (data) {
                    alert(data.message);

                    // Call the update-response-sent route to update the response_sent field
                    $.ajax({
                        type: "POST",
                        url: "/update-response-sent",
                        data: { response_id: data.response_id }, // Use the response_id returned from the /send-response endpoint
                        success: function (data) {
                            alert(data.message); // Alert for debugging
                            // Replace the button with text "Responded" and add a class to the <td>
                            var responseCell = document.getElementById("responseCell");
                            responseCell.innerHTML = "Responded";
                            responseCell.classList.add("responded");
                        },
                        error: function (xhr, status, error) {
                            console.error(xhr.responseText);
                        }
                    });

                    closeResponseModal(); // Close the modal after sending response
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }
    </script>
    
</body>

</html>